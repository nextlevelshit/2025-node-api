<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cache API GUI</title>
    <style>
      /* Minimal brutalist styling because we're not here for beauty contests */
      body {
        font-family: "Courier New", monospace;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border: 2px solid #333;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      input,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        font-family: inherit;
        border: 1px solid #666;
        box-sizing: border-box;
      }

      button {
        background: #333;
        color: white;
        cursor: pointer;
        width: auto;
        padding: 10px 20px;
      }

      button:hover {
        background: #555;
      }

      .response {
        background: #f9f9f9;
        border-left: 4px solid #007acc;
        padding: 10px;
        margin: 10px 0;
        white-space: pre-wrap;
        font-family: "Courier New", monospace;
        max-height: 300px;
        overflow-y: auto;
      }

      .error {
        border-left-color: #cc0000;
      }

      .success {
        border-left-color: #00cc00;
      }

      .inline-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .inline-buttons button {
        flex: 1;
        min-width: 120px;
      }

      .key-item {
        background: #eee;
        padding: 5px 10px;
        margin: 2px;
        border-radius: 3px;
        display: inline-block;
        cursor: pointer;
        border: 1px solid #ccc;
      }

      .key-item:hover {
        background: #ddd;
      }
    </style>
  </head>
  <body>
    <h1>Cache API Interface</h1>
    <p>Simple CRUD for your cache service running on localhost:{{PORT}}</p>

    <div class="grid">
      <!-- GET All Keys Section -->
      <div class="section">
        <h2>üóÇÔ∏è All Keys</h2>
        <button onclick="getAllKeys()">Fetch All Keys</button>
        <div id="keysResponse" class="response" style="display: none"></div>
      </div>

      <!-- GET Single Item Section -->
      <div class="section">
        <h2>üîç GET Single Item</h2>
        <input type="text" id="getKey" placeholder="Enter key to retrieve" />
        <button onclick="getData()">Fetch Item</button>
        <div id="getResponse" class="response" style="display: none"></div>
      </div>
    </div>

    <!-- POST Section -->
    <div class="section">
      <h2>üìù CREATE Data</h2>
      <textarea
        id="postData"
        rows="6"
        placeholder='{"payload": "hello world", "meta": {"created": "now"}}'
      ></textarea>
      <div class="inline-buttons">
        <button onclick="postData()">Create Item</button>
        <button onclick="fillSampleData()">Fill Sample Data</button>
      </div>
      <div id="postResponse" class="response" style="display: none"></div>
    </div>

    <!-- Cache Stats Section -->
    <div class="section">
      <h2>üìä Cache Status</h2>
      <div class="inline-buttons">
        <button onclick="getCacheStats()">Refresh Stats</button>
        <button onclick="runQuickTest()">Run Full Test</button>
      </div>
      <div id="statsResponse" class="response" style="display: none"></div>
    </div>

    <script>
      // Base URL - adjust if your server runs elsewhere
      const BASE_URL = "http://localhost:{{PORT}}/api";

      // GET all keys
      async function getAllKeys() {
        const responseDiv = document.getElementById("keysResponse");

        try {
          const response = await fetch(BASE_URL);
          const data = await response.json();

          if (response.ok) {
            let output = `Found ${data.keys.length} keys:\n\n`;

            if (data.keys.length === 0) {
              output += "Cache is empty";
            } else {
              // Show clickable keys
              output += data.keys.map((key) => `üìù ${key}`).join("\n");

              // Add clickable key elements
              setTimeout(() => {
                const keyContainer = document.createElement("div");
                keyContainer.style.marginTop = "10px";
                data.keys.forEach((key) => {
                  const keySpan = document.createElement("span");
                  keySpan.className = "key-item";
                  keySpan.textContent = key;
                  keySpan.onclick = () => {
                    document.getElementById("getKey").value = key;
                    getData();
                  };
                  keyContainer.appendChild(keySpan);
                });
                responseDiv.appendChild(keyContainer);
              }, 100);
            }

            showResponse(responseDiv, output, "success");
          } else {
            showResponse(
              responseDiv,
              `HTTP ${response.status}: ${response.statusText}`,
              "error",
            );
          }
        } catch (error) {
          showResponse(responseDiv, `Network error: ${error.message}`, "error");
        }
      }

      // GET single item
      async function getData() {
        const key = document.getElementById("getKey").value.trim();
        const responseDiv = document.getElementById("getResponse");

        if (!key) {
          showResponse(responseDiv, "Please enter a key", "error");
          return;
        }

        try {
          const response = await fetch(`${BASE_URL}/${key}`);

          if (response.ok) {
            const data = await response.json();
            const output = `‚úÖ Retrieved data for key: ${key}\n\n${JSON.stringify(data, null, 2)}`;
            showResponse(responseDiv, output, "success");
          } else {
            const errorText = await response.text();
            showResponse(
              responseDiv,
              `‚ùå HTTP ${response.status}: ${errorText || "Key not found"}`,
              "error",
            );
          }
        } catch (error) {
          showResponse(
            responseDiv,
            `‚ùå Network error: ${error.message}`,
            "error",
          );
        }
      }

      // POST new data
      async function postData() {
        const data = document.getElementById("postData").value.trim();
        const responseDiv = document.getElementById("postResponse");

        if (!data) {
          showResponse(responseDiv, "Please enter JSON data", "error");
          return;
        }

        try {
          // Validate JSON first
          const jsonData = JSON.parse(data);

          const response = await fetch(BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(jsonData),
          });

          if (response.ok) {
            const result = await response.json();
            const output = `‚úÖ Item created successfully!\n\nGenerated key: ${result.key}\n\nStored data:\n${JSON.stringify(result.data, null, 2)}`;
            showResponse(responseDiv, output, "success");

            // Auto-refresh keys
            getAllKeys();
          } else {
            const errorText = await response.text();
            showResponse(
              responseDiv,
              `‚ùå HTTP ${response.status}: ${errorText}`,
              "error",
            );
          }
        } catch (error) {
          if (error instanceof SyntaxError) {
            showResponse(
              responseDiv,
              `‚ùå Invalid JSON: ${error.message}`,
              "error",
            );
          } else {
            showResponse(
              responseDiv,
              `‚ùå Network error: ${error.message}`,
              "error",
            );
          }
        }
      }

      // Fill sample data
      function fillSampleData() {
        const samples = [
          '{"message": "Hello Cache!", "timestamp": "' +
            new Date().toISOString() +
            '"}',
          '{"user": "michael", "action": "test", "data": [1, 2, 3, 4, 5]}',
          '{"config": {"theme": "dark", "lang": "de"}, "preferences": {"notifications": true}}',
        ];

        const randomSample =
          samples[Math.floor(Math.random() * samples.length)];
        document.getElementById("postData").value = randomSample;
      }

      // Get cache statistics
      async function getCacheStats() {
        const responseDiv = document.getElementById("statsResponse");

        try {
          const response = await fetch(BASE_URL);
          const data = await response.json();

          if (response.ok) {
            const stats =
              `üìä Cache Statistics\n\n` +
              `Total items: ${data.keys.length}\n` +
              `Keys: ${data.keys.length > 0 ? data.keys.join(", ") : "None"}\n` +
              `Server: localhost:{{PORT}}\n` +
              `Last updated: ${new Date().toLocaleString("de-DE")}`;

            showResponse(responseDiv, stats, "success");
          } else {
            showResponse(
              responseDiv,
              `‚ùå Failed to fetch stats: ${response.status}`,
              "error",
            );
          }
        } catch (error) {
          showResponse(
            responseDiv,
            `‚ùå Network error: ${error.message}`,
            "error",
          );
        }
      }

      // Comprehensive test sequence
      async function runQuickTest() {
        const responseDiv = document.getElementById("statsResponse");
        let log = "üöÄ Running comprehensive test sequence...\n\n";

        try {
          // Test 1: Check current state
          log += "1Ô∏è‚É£ Checking initial state...\n";
          const initialResponse = await fetch(BASE_URL);
          const initialData = await initialResponse.json();
          log += `   Initial keys: ${initialData.keys.length}\n`;

          // Test 2: POST some data
          log += "\n2Ô∏è‚É£ Creating test data...\n";
          const testData = {
            payload: "test_data_" + Date.now(),
            meta: { created: new Date().toISOString(), test: true },
          };

          const postResponse = await fetch(BASE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testData),
          });

          if (postResponse.ok) {
            const postResult = await postResponse.json();
            log += `   ‚úÖ POST successful - key: ${postResult.key}\n`;

            // Test 3: GET the data back
            log += "\n3Ô∏è‚É£ Retrieving created data...\n";
            const getResponse = await fetch(`${BASE_URL}/${postResult.key}`);

            if (getResponse.ok) {
              const retrievedData = await getResponse.json();
              log += `   ‚úÖ GET successful\n`;
              log += `   Data matches: ${JSON.stringify(retrievedData) === JSON.stringify(testData)}\n`;
            } else {
              log += `   ‚ùå GET failed: ${getResponse.status}\n`;
            }

            // Test 4: Check final state
            log += "\n4Ô∏è‚É£ Checking final state...\n";
            const finalResponse = await fetch(BASE_URL);
            const finalData = await finalResponse.json();
            log += `   Final keys: ${finalData.keys.length}\n`;
            log += `   Keys increased: ${finalData.keys.length > initialData.keys.length}\n`;
          } else {
            log += `   ‚ùå POST failed: ${postResponse.status}\n`;
          }

          log += "\n‚úÖ Test sequence completed!";
          showResponse(responseDiv, log, "success");

          // Refresh the keys display
          getAllKeys();
        } catch (error) {
          log += `\n‚ùå Test failed: ${error.message}`;
          showResponse(responseDiv, log, "error");
        }
      }

      // Utility to show responses with styling
      function showResponse(element, message, type = "") {
        element.textContent = message;
        element.style.display = "block";
        element.className = `response ${type}`;
      }

      // Enter key support for inputs
      document
        .getElementById("getKey")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") getData();
        });

      // Auto-load keys on page load
      document.addEventListener("DOMContentLoaded", function () {
        getAllKeys();
      });
    </script>
  </body>
</html>
